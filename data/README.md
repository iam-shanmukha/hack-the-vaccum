# Data Directory

Sample data files, configurations, and captured data from the vacuum cleaner.

## Configuration Files

### tinytuya.json

**Tuya Cloud API credentials.**

```json
{
    "apiKey": "your_api_key",
    "apiSecret": "your_api_secret",
    "apiRegion": "in",
    "apiDeviceID": "your_device_id"
}
```

**Used by:**
- `discovery/tuya_get_local.py`
- `mapping/vaccum_map_test.py`

**Getting these values:**
1. Go to [iot.tuya.com](https://iot.tuya.com)
2. Create cloud project
3. Note API Key and Secret
4. Link Smart Life app
5. Get device ID from device list

## Map Data Files

### map_coords.json

**Extracted coordinate pairs from map data.**

Sample structure:
```json
[
  [170, 5889],
  [768, 297],
  [170, 7004],
  ...
]
```

**Format:**
- Array of `[x, y]` coordinate pairs
- Units: millimeters from origin (charging dock)
- Extracted using `mapping/decode_map.py`

### map_decoded.json

**Fully decoded map structure.**

Sample structure:
```json
{
  "raw_size": 121,
  "hex_preview": "aa00011717aa00032901002aaa005c1b05...",
  "magic": "0x00aa",
  "version": 1,
  "type": "path",
  "coordinates": [[x1, y1], [x2, y2], ...],
  "point_count": 29
}
```

**Fields:**
- `raw_size`: Original binary size in bytes
- `magic`: Header magic bytes (identifies format)
- `version`: Map format version
- `type`: Data type ('path', 'rooms', 'compressed')
- `coordinates`: Decoded coordinate pairs
- `point_count`: Number of points

**Generated by:** `mapping/tuya_decoder.py`

### map_raw.bin

**Raw binary map data after base64 decode.**

**Format:** Binary
**Size:** ~121 bytes (typical)

**Structure:**
```
Offset 0x00: AA 00        (Magic bytes)
Offset 0x02: 01           (Version)
Offset 0x03: ...          (Map data)
```

**Use with:**
- Hex editors for manual analysis
- Custom decoders
- Format research

## Map Visualizations

### map_bitmap_*.png

**Various bitmap interpretations of map data.**

Generated by trying different:
- Header sizes (4, 8, 16 bytes)
- Image dimensions (50×50, 100×100, 128×128, etc.)

**Naming convention:**
```
map_bitmap_{width}x{height}_h{header_size}.png
```

Example: `map_bitmap_10x10_h16.png`
- 10×10 pixel grid
- 16-byte header offset

**Most are unsuccessful** - map data is coordinates, not bitmap.

### vacuum_path.png

**Visualization of vacuum's cleaning path.**

Shows:
- Path as connected line
- Start point (green)
- End point (red)
- Coordinate grid

Generated by `mapping/visualize_map.py`

### room_map_proper.png

**Clean visualization of room boundaries.**

Shows:
- Room rectangles with colors
- Room labels (R1, R2, etc.)
- Coordinate axes
- Grid overlay

Generated by `mapping/map_visualizer_v2.py`

**Best visualization for understanding floor plan.**

## Network Captures

### vacuum.pcap

**Basic connectivity capture.**

**Size:** 24 bytes
**Content:** Initial connection packet
**Captured with:** `tcpdump -i any port 6668 -w vacuum.pcap`

### vacuum_broadcast.pcap

**UDP broadcast packets.**

**Size:** 720 bytes
**Content:** Device discovery broadcasts
**Port:** 6667 UDP
**Captured with:** `tcpdump -i any port 6667 -w vacuum_broadcast.pcap`

**Structure:**
```
0x0000: 00 00       (Prefix)
0x0002: 55 AA       (Magic)
0x0004: ...         (Device info)
```

### vacuum_app.pcap

**Smart Life app communication.**

**Size:** 7.2 KB
**Content:** App ↔ vacuum communication
**Includes:**
- Status requests
- Command sequences
- Map data transfers

**Analyze with:**
```bash
tcpdump -r vacuum_app.pcap -X
# or
wireshark vacuum_app.pcap
```

## File Usage

### For Map Visualization

```bash
# Use decoded coordinates
python3 << EOF
import json
import matplotlib.pyplot as plt

with open('data/map_coords.json') as f:
    coords = json.load(f)

xs, ys = zip(*coords)
plt.plot(xs, ys)
plt.savefig('my_map.png')
EOF
```

### For Protocol Analysis

```bash
# View raw binary
hexdump -C data/map_raw.bin

# Check structure
python3 << EOF
with open('data/map_raw.bin', 'rb') as f:
    data = f.read()
    print(f"Magic: {data[0:2].hex()}")
    print(f"Version: {data[2]}")
    print(f"Size: {len(data)} bytes")
EOF
```

### For Network Analysis

```bash
# View captures
tcpdump -r data/vacuum.pcap -X
tcpdump -r data/vacuum_broadcast.pcap -X
tcpdump -r data/vacuum_app.pcap -X

# Extract specific packets
tcpdump -r data/vacuum_app.pcap 'tcp[13] & 8 != 0' -X
```

## Generating New Data

### Capture New Map

```bash
# Method 1: Active request
python3 mapping/banthi_get_map.py  # Option 1
# Output: map_dps_15_*.bin

# Method 2: Passive monitoring
python3 mapping/banthi_get_map.py  # Option 2
# Output: map_dps_*_{timestamp}.bin
```

### Capture Network Traffic

```bash
# Full capture
sudo tcpdump -i any host 192.168.x.x -w my_capture.pcap

# Control port only
sudo tcpdump -i any port 6668 -w control_capture.pcap

# Broadcast only
sudo tcpdump -i any port 6667 -w broadcast_capture.pcap
```

### Export Current Map

```bash
python3 << EOF
import tinytuya
import json

vacuum = tinytuya.Device(
    dev_id="your_id",
    address="192.168.x.x",
    local_key="your_key",
    version=3.3
)

# Request map
vacuum.set_value('121', 'get_both')

# Get map data
import time
time.sleep(3)
status = vacuum.status()
map_data = status['dps'].get('15')

# Save
with open('current_map.txt', 'w') as f:
    f.write(map_data)
print("Saved!")
EOF
```

## Data Privacy

**This directory may contain sensitive information:**

- API keys and secrets
- Device IDs
- Local keys
- Network captures with MAC addresses

**Security best practices:**
1. Add `data/` to `.gitignore`
2. Don't share `.pcap` files publicly
3. Redact credentials before sharing
4. Use environment variables for keys

## Sample Data Analysis

### Map Data Statistics

From `map_decoded.json`:
- **Points captured**: 29 coordinate pairs
- **Data size**: 121 bytes
- **Format**: Tuya proprietary (type: path)
- **Coordinate range**: -30206 to +23552 mm (~-30m to +24m)

### Typical Values

- **Battery**: 0-100 (percentage)
- **Cleaning time**: 0-3600 (seconds per session)
- **Cleaning area**: 0-500000 (cm² per session)
- **Brush life**: 0-180 (cycles remaining)
- **Filter life**: 0-100 (percentage)

## See Also

- [../docs/PROTOCOL.md](../docs/PROTOCOL.md) - Data format specifications
- [../mapping/README.md](../mapping/README.md) - How to use map files
- [../docs/SETUP_GUIDE.md](../docs/SETUP_GUIDE.md) - Getting credentials
